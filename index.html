<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HereNow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #eee;
      padding: 2rem;
      max-width: 640px;
      margin: auto;
    }

    .meta { opacity: .85; margin: 0.25rem 0 1rem; }

    input, textarea, button {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.75rem;
      font-size: 1rem;
      font-family: inherit;
      box-sizing: border-box;
      border-radius: 12px;
      border: 1px solid #333;
      background: #0b0b0b;
      color: #eee;
      outline: none;
    }

    textarea { min-height: 110px; resize: vertical; }

    button {
      cursor: pointer;
      font-weight: 600;
      background: #161616;
    }

    button:active { transform: translateY(1px); }

    .card {
      margin-top: 1.5rem;
      padding: 1rem;
      border: 1px solid #333;
      border-radius: 16px;
      background: #0b0b0b;
    }

    #links, #msg, #updated, #pageLabel, #debug {
      font-size: 0.95rem;
      opacity: 0.9;
      word-break: break-word;
    }

    #live { white-space: pre-line; line-height: 1.45; }
    a { color: #9ad; }
    hr { border: none; border-top: 1px solid #222; margin: 1rem 0; }
  </style>
</head>

<body>
  <h1>HereNow</h1>
  <p class="meta">Version: 5</p>

  <p id="pageLabel" class="meta"></p>
  <p id="debug" class="meta"></p>

  <input id="mood" placeholder="Current mood" />
  <input id="music" placeholder="Listening to" />
  <input id="game" placeholder="Playing / watching" />
  <textarea id="work" placeholder="Working on"></textarea>

  <button id="save">Save</button>

  <p id="msg"></p>
  <p id="links"></p>

  <div class="card">
    <h3 style="margin-top:0;">Live view</h3>
    <p id="updated"></p>
    <hr />
    <p id="live"></p>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      // ✅ PASTE YOUR REAL Firebase config values here
      const firebaseConfig = {
      apiKey: "AIzaSyAJWypqDstoZmXUVXbfhryept8blcvup8c",
      authDomain: "herenowv2.firebaseapp.com",
      projectId: "herenowv2",
      storageBucket: "herenowv2.firebasestorage.app",
      messagingSenderId: "991126883333",
      appId: "1:991126883333:web:8fba2f2105167b7473e06c"
    };


      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ---- URL identity ----
      const params = new URLSearchParams(window.location.search);
      const uRaw = (params.get("u") || "demo").trim();
      const u = (uRaw.toLowerCase().replace(/[^a-z0-9_-]/g, "").slice(0, 32)) || "demo";
      const editKey = (params.get("edit") || "").trim();

      document.title = `HereNow — ${u}`;

      const docRef = db.collection("pages").doc(u);

      // ---- Elements ----
      const moodEl = document.getElementById("mood");
      const musicEl = document.getElementById("music");
      const gameEl = document.getElementById("game");
      const workEl = document.getElementById("work");
      const saveBtn = document.getElementById("save");

      const msgEl = document.getElementById("msg");
      const linksEl = document.getElementById("links");
      const updatedEl = document.getElementById("updated");
      const liveEl = document.getElementById("live");
      const pageLabelEl = document.getElementById("pageLabel");
      const debugEl = document.getElementById("debug");

      pageLabelEl.innerText = `Page: ${u}`;
      debugEl.innerText = `Doc: pages/${u} | Edit param: ${editKey ? "yes" : "no"}`;
      msgEl.innerText = `Ready (page: ${u}).`;

      function baseURL() {
        return window.location.origin + window.location.pathname;
      }

      function viewURL() {
        return `${baseURL()}?u=${encodeURIComponent(u)}`;
      }

      function editURL(editId) {
        return `${baseURL()}?u=${encodeURIComponent(u)}&edit=${encodeURIComponent(editId)}`;
      }

      function showLinks(editId) {
        const v = viewURL();
        let html = `View link:<br><a href="${v}" target="_blank">${v}</a>`;

        if (editId) {
          const e = editURL(editId);
          html += `<br><br>Edit link (keep private):<br><a href="${e}" target="_blank">${e}</a>`;
        }

        linksEl.innerHTML = html;
      }

      // Always show view link, even before doc exists
      showLinks("");

      // ---- Save (edit-protected) ----
      // Logic:
      // - If doc has an editId already, you must provide it in URL (?edit=...)
      // - If doc doesn't exist yet, first save "claims" it and sets an editId (shown as edit link)
      //
      // Note: real protection ultimately needs rules/auth. This is the clean client behavior.
      saveBtn.onclick = async () => {
        msgEl.innerText = "Saving…";

        try {
          // Read current doc state (we need this for true view/edit behavior)
          const snap = await docRef.get();
          const existing = snap.exists ? snap.data() : null;

          // If page already claimed, require correct editKey
          if (existing?.editId && editKey !== existing.editId) {
            msgEl.innerText = "View-only link. Use the private edit link to change this page.";
            alert("View-only link. You need the edit link to change this page.");
            return;
          }

          // Claim or reuse editId
          const editIdToUse = existing?.editId || editKey || crypto.randomUUID();

          const writePromise = docRef.set({
            mood: moodEl.value,
            music: musicEl.value,
            game: gameEl.value,
            work: workEl.value,
            editId: editIdToUse,
            updated: new Date()
          }, { merge: true });

          // Update UI immediately
          msgEl.innerText = "Saved ✓";
          showLinks(editIdToUse);

          await writePromise;
        } catch (err) {
          msgEl.innerText = "Save failed: " + (err?.message || err);
        }
      };

      // ---- Live updates ----
      docRef.onSnapshot((doc) => {
        const d = doc.data();

        if (!d) {
          liveEl.innerText = `No page yet for "${u}". Type and hit Save to create it.`;
          updatedEl.innerText = "";
          // Keep only view link visible
          showLinks("");
          return;
        }

        liveEl.innerText =
          `Mood: ${d.mood || ""}\n` +
          `Music: ${d.music || ""}\n` +
          `Game: ${d.game || ""}\n` +
          `Working on: ${d.work || ""}`;

        // updated may come back as Firestore Timestamp or Date
        if (d.updated && d.updated.toDate) {
          const dt = d.updated.toDate();
          updatedEl.innerText = "Last updated: " + dt.toLocaleString([], { dateStyle: "medium", timeStyle: "short" });
        } else if (d.updated) {
          updatedEl.innerText = "Last updated: " + String(d.updated);
        } else {
          updatedEl.innerText = "";
        }

        // Show edit link if doc has one
        showLinks(d.editId || "");
      });
    });
  </script>
</body>
</html>
