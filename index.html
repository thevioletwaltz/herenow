<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HereNow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <style>
  body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: #eee;
    padding: 2rem;
    max-width: 600px;
    margin: auto;
  }

  input, textarea, button {
    width: 100%;
    margin: 0.5rem 0;
    padding: 0.6rem;
    font-size: 1rem;
    font-family: inherit; /* <-- add this */
  }

  button {
    cursor: pointer;
  }

  .card {
    margin-top: 2rem;
    padding: 1rem;
    border: 1px solid #333;
  }
</style>
</head>
<body>

  <h1>HereNow</h1>

  <input id="mood" placeholder="Current mood" />
  <input id="music" placeholder="Listening to" />
  <input id="game" placeholder="Playing / watching" />
  <textarea id="work" placeholder="Working on"></textarea>

<p id="editLink" style="font-size:0.9rem; opacity:0.7;"></p>

<button id="save">Save</button>

  <div class="card">
  <h3>Live view</h3>
  <p id="updated" style="opacity:0.7; margin-top:0.5rem;"></p>
  <p id="live"></p>
</div>

  <script>
  const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "herenow.firebaseapp.com",
  projectId: "herenow",
  storageBucket: "herenow.appspot.com",
  messagingSenderId: "123456",
  appId: "1:123:web:abc"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ---------- URL-based page id ----------
  const params = new URLSearchParams(window.location.search);
  const uRaw = (params.get("u") || "demo").trim();
  const u = uRaw.toLowerCase().replace(/[^a-z0-9_-]/g, "").slice(0, 32) || "demo";

  // Optional edit key (secret)
  const editKey = (params.get("edit") || "").trim();

  // Each user gets their own doc
  const docRef = db.collection("pages").doc(u);

  // UI elements (adjust ids if yours differ)
  const moodEl = document.getElementById("mood");
  const musicEl = document.getElementById("music");
  const gameEl = document.getElementById("game");
  const workEl = document.getElementById("work");
  const liveEl = document.getElementById("live");
  const updatedEl = document.getElementById("updated");
  const saveBtn = document.getElementById("save");
  const editLinkEl = document.getElementById("editLink");


  // Helper: show current URLs
  function showLinks(docData) {
  if (!editLinkEl) return; // ‚Üê THIS LINE PREVENTS TOTAL FAILURE

  const base = window.location.origin + window.location.pathname;
  const viewURL = `${base}?u=${encodeURIComponent(u)}`;
  const newEdit = docData?.editId || editKey || "";
  const editURL = newEdit
    ? `${base}?u=${encodeURIComponent(u)}&edit=${encodeURIComponent(newEdit)}`
    : "";

  if (editURL) {
    editLinkEl.innerHTML =
      `Edit link (keep private):<br><a href="${editURL}">${editURL}</a>`;
  } else {
    editLinkEl.innerText = "";
  }
}

  // Save (only allowed if you have the edit key)
  saveBtn.onclick = async () => {
    // If doc doesn't exist yet, allow first save to "claim" it and generate editId
    const snap = await docRef.get();
    const existing = snap.exists ? snap.data() : null;

    // If it exists and has an editId, require the correct key
    if (existing?.editId && editKey !== existing.editId) {
      alert("View-only link. You need the edit link to change this page.");
      return;
    }

    // If this is the first time, generate an editId
    const editIdToUse = existing?.editId || editKey || crypto.randomUUID();

    await docRef.set({
      mood: moodEl.value,
      music: musicEl.value,
      game: gameEl.value,
      work: workEl.value,
      editId: editIdToUse, // stored once, acts like password
      updated: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    // If you didn't have an edit key in the URL, tell you the new edit link in console
    showLinks({ editId: editIdToUse });
  };

  // Live updates
  docRef.onSnapshot((doc) => {
    const d = doc.data();
    if (!d) {
      liveEl.innerText = `No page yet for "${u}". Type and hit Save to create it.`;
      updatedEl.innerText = "";
      return;
    }

    liveEl.innerText =
      `Mood: ${d.mood || ""}\nMusic: ${d.music || ""}\nGame: ${d.game || ""}\nWorking on: ${d.work || ""}`;

    if (d.updated && d.updated.toDate) {
      const dt = d.updated.toDate();
      updatedEl.innerText =
        "Last updated: " + dt.toLocaleString([], { dateStyle: "medium", timeStyle: "short" });
    } else {
      updatedEl.innerText = "";
    }

    showLinks(d);
  });
</script>


</body>
</html>
