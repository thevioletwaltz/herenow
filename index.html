<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HereNow</title>
  
  <h1>Version: 2</h1>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase (compat so we can use firebase.initializeApp / firestore easily) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #eee;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }

    input, textarea, button {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.6rem;
      font-size: 1rem;
      font-family: inherit;
      box-sizing: border-box;
    }

    button { cursor: pointer; }

    .card {
      margin-top: 2rem;
      padding: 1rem;
      border: 1px solid #333;
    }

    #editLink, #msg, #updated { font-size: 0.95rem; opacity: 0.8; }
    #live { white-space: pre-line; }
    a { color: #9ad; }
  </style>
</head>

<body>
  <h1>HereNow</h1>

  <input id="mood" placeholder="Current mood" />
  <input id="music" placeholder="Listening to" />
  <input id="game" placeholder="Playing / watching" />
  <textarea id="work" placeholder="Working on"></textarea>

  <button id="save">Save</button>

  <p id="msg"></p>
  <p id="editLink"></p>

  <div class="card">
    <h3>Live view</h3>
    <p id="updated"></p>
    <p id="live"></p>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      // ---- Firebase config (KEEP YOUR REAL VALUES) ----
      const firebaseConfig = {
  apiKey: "AIzaSyB3X9sdf98sd98sd9sd",
  authDomain: "herenow.firebaseapp.com",
  projectId: "herenow",
  storageBucket: "herenow.appspot.com",
  messagingSenderId: "9876543210",
  appId: "1:9876543210:web:abcd1234efgh"
  };

      // ---- Init ----
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ---- Page identity from URL ----
      const params = new URLSearchParams(window.location.search);
      const uRaw = (params.get("u") || "demo").trim();
      const u = uRaw.toLowerCase().replace(/[^a-z0-9_-]/g, "").slice(0, 32) || "demo";
      const editKey = (params.get("edit") || "").trim();

      const docRef = db.collection("pages").doc(u);

      // ---- Elements ----
      const moodEl = document.getElementById("mood");
      const musicEl = document.getElementById("music");
      const gameEl = document.getElementById("game");
      const workEl = document.getElementById("work");
      const saveBtn = document.getElementById("save");

      const msgEl = document.getElementById("msg");
      const editLinkEl = document.getElementById("editLink");
      const updatedEl = document.getElementById("updated");
      const liveEl = document.getElementById("live");

      msgEl.innerText = `Ready (page: ${u}).`;

      function makeLinks(editId) {
        const base = window.location.origin + window.location.pathname;
        const viewURL = `${base}?u=${encodeURIComponent(u)}`;
        const editURL = editId ? `${base}?u=${encodeURIComponent(u)}&edit=${encodeURIComponent(editId)}` : "";
        return { viewURL, editURL };
      }

      function showEditLink(editId) {
        if (!editLinkEl) return;
        if (!editId) {
          editLinkEl.innerText = "";
          return;
        }
        const { editURL } = makeLinks(editId);
        editLinkEl.innerHTML = `Edit link (keep private):<br><a href="${editURL}">${editURL}</a>`;
      }

  // ---- Save (edit-protected, NO pre-read) ----
saveBtn.onclick = async () => {
  msgEl.innerText = "Saving…";

  // Use edit key from URL OR keep one stable per page in localStorage
  const keyName = `herenow_edit_${u}`;
  let editIdToUse = editKey || localStorage.getItem(keyName);

  if (!editIdToUse) {
    editIdToUse = crypto.randomUUID();
    localStorage.setItem(keyName, editIdToUse);
  }

  try {
    await docRef.set({
      mood: moodEl.value,
      music: musicEl.value,
      game: gameEl.value,
      work: workEl.value,
      editId: editIdToUse,
      updated: new Date()
    }, { merge: true });

    msgEl.innerText = "Saved ✓";
    showEditLink(editIdToUse);
  } catch (err) {
    msgEl.innerText = "Save failed: " + (err?.message || err);
  }
};

      // ---- Live updates ----
      docRef.onSnapshot((doc) => {
        const d = doc.data();

        if (!d) {
          liveEl.innerText = `No page yet for "${u}". Type and hit Save to create it.`;
          updatedEl.innerText = "";
          // Don't show edit link until created
          showEditLink("");
          return;
        }

        liveEl.innerText =
          `Mood: ${d.mood || ""}\n` +
          `Music: ${d.music || ""}\n` +
          `Game: ${d.game || ""}\n` +
          `Working on: ${d.work || ""}`;

        if (d.updated && d.updated.toDate) {
          const dt = d.updated.toDate();
          updatedEl.innerText = "Last updated: " + dt.toLocaleString([], { dateStyle: "medium", timeStyle: "short" });
        } else {
          updatedEl.innerText = "";
        }

        // If you're on the edit link (or just created it), show it
        if (d.editId) showEditLink(d.editId);
      });
    });
  </script>
</body>
</html>
