<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HereNow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- Top-of-page header with avatar + title -->
  <div class="page-header">
    <div class="avatar-wrap">
      <img id="avatarImg" src="avatar.png" alt="User avatar" />
    </div>

    <div class="title-wrap">
      <h1>HereNow</h1>
      <p class="meta">Version: 8.0 (pets + tidy editor)</p>
      <p id="pageLabel" class="meta"></p>
    </div>
  </div>

  <!-- Edit toggle + editor -->
  <button id="toggleEdit">Edit</button>

  <div id="editor">
    <div class="field-row">
      <label for="mood">Mood:</label>
      <input id="mood" placeholder="Current mood" />
    </div>

    <div class="field-row">
      <label for="music">Music:</label>
      <input id="music" placeholder="Listening to" />
    </div>

    <div class="field-row">
      <label for="game">Game / watching:</label>
      <input id="game" placeholder="Playing / watching" />
    </div>

    <div class="field-row">
      <label for="status">Current status:</label>
      <textarea id="status" placeholder="What are you up to?"></textarea>
    </div>

    <div class="field-row">
      <label for="petSelect">Pet:</label>
      <select id="petSelect">
        <option value="nightcat">Nightcat</option>
        <option value="mochibun">Mochi Bun</option>
        <option value="emberfox">Plush Fox</option>
      </select>
    </div>

    <div class="field-row">
      <label for="petName">Pet name:</label>
      <input id="petName" placeholder="Nightcat" />
    </div>

    <button id="save">Save</button>
    <p id="msg"></p>
  </div>

  <!-- Live view card with avatar and pet -->
  <div class="card">
    <div class="card-header">
      <div class="avatar-wrap card-avatar">
        <img src="avatar.png" alt="User avatar small" />
      </div>

      <div class="card-header-text">
        <h3 id="liveTitle">Live view</h3>
        <p id="updated"></p>
      </div>
    </div>

    <hr />
    <p id="live"></p>

    <!-- Pet in bottom-right corner -->
    <div class="pet-slot">
      <img id="petImg" src="cat.png" alt="Pet" />
      <div class="pet-name" id="petNameDisplay">Nightcat</div>
    </div>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      // Your real Firebase config for herenowv2
      const firebaseConfig = {
        apiKey: "AIzaSyAJWypqDstoZmXUVXbfhryept8blcvup8c",
        authDomain: "herenowv2.firebaseapp.com",
        projectId: "herenowv2",
        storageBucket: "herenowv2.firebasestorage.app",
        messagingSenderId: "991126883333",
        appId: "1:991126883333:web:8fba2f2105167b7473e06c"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ---- URL identity: one page per ?u= ----
      const params = new URLSearchParams(window.location.search);
      const uRaw = (params.get("u") || "demo").trim(); // default demo
      const u = (uRaw.toLowerCase().replace(/[^a-z0-9_-]/g, "").slice(0, 32)) || "demo";

      document.title = `HereNow — ${u}`;
      const docRef = db.collection("pages").doc(u);

      // ---- Elements ----
      const moodEl   = document.getElementById("mood");
      const musicEl  = document.getElementById("music");
      const gameEl   = document.getElementById("game");
      const statusEl = document.getElementById("status");
      const petSelectEl = document.getElementById("petSelect");
      const petNameEl   = document.getElementById("petName");
      const saveBtn  = document.getElementById("save");

      const msgEl       = document.getElementById("msg");
      const updatedEl   = document.getElementById("updated");
      const liveEl      = document.getElementById("live");
      const pageLabelEl = document.getElementById("pageLabel");
      const toggleEditBtn = document.getElementById("toggleEdit");
      const editorEl    = document.getElementById("editor");
      const liveTitleEl = document.getElementById("liveTitle");

      const petImgEl          = document.getElementById("petImg");
      const petNameDisplayEl  = document.getElementById("petNameDisplay");

      pageLabelEl.innerText = `User: ${u}`;
      liveTitleEl.innerText = u;
      msgEl.innerText = `Ready (page: ${u}).`;

      // ---- Edit toggle ----
      let editing = false;
      function updateEditUI() {
        if (editing) {
          editorEl.style.display = "block";
          toggleEditBtn.innerText = "Done";
        } else {
          editorEl.style.display = "none";
          toggleEditBtn.innerText = "Edit";
        }
      }
      toggleEditBtn.onclick = () => {
        editing = !editing;
        updateEditUI();
      };
      updateEditUI(); // start hidden

      // ---- Pet mapping ----
      const petMap = {
        nightcat: { src: "cat.png",  defaultName: "Nightcat" },
        mochibun: { src: "mochi.png", defaultName: "Mochi Bun" },
        plushfox: { src: "fox.png",  defaultName: "Plush Fox" }
      };

      function applyPet(petKey, petName) {
        const def = petMap[petKey] || petMap.nightcat;
        petImgEl.src = def.src;
        petNameDisplayEl.innerText = petName || def.defaultName;
        if (!petNameEl.value) {
          petNameEl.placeholder = def.defaultName;
        }
      }

      // ---- Save (everyone with link can edit, for now) ----
      saveBtn.onclick = async () => {
        msgEl.innerText = "Saving…";
        try {
          const petKey = petSelectEl.value || "nightcat";
          const petName = petNameEl.value.trim();

          const statusVal = statusEl.value;

          const data = {
            mood: moodEl.value,
            music: musicEl.value,
            game: gameEl.value,
            status: statusVal,
            work: statusVal,        // keep older field name too, for compatibility
            petKey,
            petName,
            updated: new Date()
          };

          await docRef.set(data, { merge: true });
          msgEl.innerText = "Saved ✓";
        } catch (err) {
          msgEl.innerText = "Save failed: " + (err?.message || err);
        }
      };

      // ---- Live updates from Firestore ----
      docRef.onSnapshot((snap) => {
        const d = snap.data();

        if (!d) {
          liveEl.innerText = `No page yet for "${u}". Tap Edit, type, and Save to create it.`;
          updatedEl.innerText = "";
          applyPet("nightcat", "");
          return;
        }

        // status can be in status or legacy work
        const statusVal =
          (typeof d.status === "string" && d.status) ||
          (typeof d.work === "string"   && d.work)   ||
          "";

        // Fill inputs
        if (typeof d.mood === "string")  moodEl.value = d.mood;
        if (typeof d.music === "string") musicEl.value = d.music;
        if (typeof d.game === "string")  gameEl.value = d.game;
        statusEl.value = statusVal;

        if (d.petKey && petMap[d.petKey]) {
          petSelectEl.value = d.petKey;
        } else {
          petSelectEl.value = "nightcat";
        }

        if (typeof d.petName === "string") {
          petNameEl.value = d.petName;
        } else {
          petNameEl.value = "";
        }

        // Live text
        liveEl.innerText =
          `Mood: ${d.mood || ""}\n` +
          `Music: ${d.music || ""}\n` +
          `Game: ${d.game || ""}\n` +
          `Current status: ${statusVal || ""}`;

        // Updated timestamp
        if (d.updated && d.updated.toDate) {
          const dt = d.updated.toDate();
          updatedEl.innerText =
            "Last updated: " + dt.toLocaleString([], { dateStyle: "medium", timeStyle: "short" });
        } else if (d.updated) {
          updatedEl.innerText = "Last updated: " + String(d.updated);
        } else {
          updatedEl.innerText = "";
        }

        // Apply pet
        const petKey = d.petKey || "nightcat";
        const petName = d.petName || "";
        applyPet(petKey, petName);
      });
    });
  </script>
</body>
</html>
